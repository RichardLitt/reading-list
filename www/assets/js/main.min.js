var hoodie=new Hoodie,app=app||{};app.pubSub=_.extend({},Backbone.Events);var bookCollectionView=new app.BookCollectionView,searchResultsView=new app.SearchResultsView,shelfCollection,shelvesCollectionView;hoodie.store.findAll("shelf").then(function(e){shelfCollection=new app.ShelfCollection(e),shelvesCollectionView=new app.ShelfCollectionView(shelfCollection),hoodie.store.findAll("book").then(function(e){e.forEach(function(e){var o=new app.Book(e);shelfCollection.forEach(function(e){e.get("name")===o.get("shelf")&&(console.log("added %s to %s",o.get("title"),e.get("name")),e.get("nested").add(o))})}),shelvesCollectionView.setIndexAsActive(0)})}),$("#listinput").on("keyup",function(e){var o=e.target.value;if(13===e.keyCode){var t=new app.Shelf({name:o});shelvesCollectionView.addShelf(t),hoodie.store.add("shelf",t.toJSON())}}),$("#bookinput").on("keyup",$.debounce(function(e){var o=e.target.value;o.length>=3&&($("#loading").show(),hoodie.isbn.searchbooks({query:o}).fail(function(){$("#loading").hide()}).done(function(e){$("#loading").hide(),searchResultsView.reset(),searchResultsView.collection.set(e.result.data)}))},555)),$(document).ready(function(){hoodie.goodreads.getinfo({username:hoodie.account.username}).fail(function(){$("#linkToGoodreads").show()}).done(function(e){e.goodreads_exists?$("#linkedToGoodreads").show():$("#linkToGoodreads").show()});var e=$("#linkToGoodreads").attr("href");$("#linkToGoodreads").attr("href",e+"?hoodie_id="+hoodie.account.username)});var app=app||{};app.BookCollection=Backbone.Collection.extend({model:app.Book});var app=app||{};app.SearchResults=Backbone.Collection.extend({model:app.Book});var app=app||{};app.ShelfCollection=Backbone.Collection.extend({model:app.Shelf,initialize:function(){this.on("setactive",this.setActive)},setActive:function(e){this.models.forEach(function(o){o.get("name")===e.get("name")?(o.set("active",!0),app.pubSub.trigger("viewingNewShelf",o.get("nested"))):o.set("active",!1),app.pubSub.trigger("renderShelves")})}});var app=app||{};app.Book=Backbone.Model.extend({defaults:{title:"",read:!1,isbn10:"",isbn13:"",author_data:[],dateAdded:moment()},initialize:function(){}});var app=app||{};app.Shelf=Backbone.Model.extend({defaults:{name:""},initialize:function(e){this.set("name",e.name),this.set("nested",e.collection||new app.BookCollection),app.pubSub.on("add:shelf",this.addBookToShelf,this),app.pubSub.on("remove:shelf",this.removeBookFromShelf,this)},setActive:function(){this.trigger("setactive",this)},addBookToShelf:function(e){this.get("active")&&(e.set("shelf",this.get("name")),this.get("nested").add(e),hoodie.store.add("book",e.toJSON()).then(function(o){e.set("id",o.id)}))},removeBookFromShelf:function(e){var o=this;o.get("active")&&hoodie.store.remove("book",e.get("id")).then(function(){o.get("nested").remove(e)})}});var app=app||{};app.BookView=Backbone.View.extend({tagName:"li",bookTpl:_.template($("#reading-list-item-template").html()),events:{"click i.remove":"deleteBook"},initialize:function(e){this.options=e||{}},render:function(){return this.$el.html(this.bookTpl(this.model.toJSON())),this},deleteBook:function(){this.remove(),console.log("deleting the book"),app.pubSub.trigger("remove:shelf",this.model)}});var app=app||{};app.BookCollectionView=Backbone.View.extend({el:"#booklist",initialize:function(e){this.collection=[],this.collection=new app.BookCollection(e),this.render(),app.pubSub.on("viewingNewShelf",this.setBookCollection,this)},render:function(){this.$el.html(""),this.collection.forEach(function(e){this.renderBook(e)},this)},renderBook:function(e){var o=new app.BookView({model:e});this.$el.append(o.render().el)},setBookCollection:function(e){console.log("collection: ",e),this.collection=e,this.collection.on("add",this.render,this),this.render()}});var app=app||{};app.SearchResultView=Backbone.View.extend({tagName:"li",bookTpl:_.template($("#search-result-template").html()),events:{click:"chooseBook"},initialize:function(e){this.options=e||{}},render:function(){return this.$el.html(this.bookTpl(this.model.toJSON())),this},chooseBook:function(){app.pubSub.trigger("add:shelf",this.model)}});var app=app||{};app.SearchResultsView=Backbone.View.extend({el:"#searchresults",initialize:function(e){this.collection=new app.BookCollection(e),this.render(),this.listenTo(this.collection,"add",this.renderBook)},reset:function(){this.$el.html(""),this.collection.reset()},render:function(){this.collection.each(function(e){this.renderBook(e)},this)},renderBook:function(e){var o=new app.SearchResultView({model:e});this.$el.append(o.render().el)}});var app=app||{};app.ShelfView=Backbone.View.extend({tagName:"li",attributes:function(){return{"class":this.model.get("active")?"active":""}},shelfTpl:_.template($("#shelf-list-item-template").html()),events:{click:"view"},initialize:function(){},render:function(){return this.$el.html(this.shelfTpl(this.model.toJSON())),this},view:function(){this.model.setActive(!0)}});var app=app||{};app.ShelfCollectionView=Backbone.View.extend({el:"#shelflist",initialize:function(e){this.collection=e,this.render(),app.pubSub.on("renderShelves",this.render,this)},render:function(){this.$el.html(""),this.collection.each(function(e){this.renderShelf(e)},this)},renderShelf:function(e){var o=new app.ShelfView({model:e});this.$el.append(o.render().el)},addShelf:function(e){this.collection.add(e),this.render()},setIndexAsActive:function(e){this.collection.models[e].setActive(!0),this.render()}});